<script>
  const supabaseUrl = 'https://mftgqxilushpzewpqkvi.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // скорочено для зручності

  const CORRECT_PIN = '9548';

  const availableBonuses = [
    {
      name: "gyros",
      title: "-50% на гірос",
    },
    {
      name: "potato",
      title: "Велика картопля за 35 грн",
    }
  ];

  function checkPin() {
    const pin = document.getElementById('pinInput').value.trim();
    const pinResult = document.getElementById('pinResult');

    if (pin === CORRECT_PIN) {
      document.getElementById('pinSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
    } else {
      pinResult.innerText = "❌ Невірний PIN-код.";
    }
  }

  async function checkCode() {
    const code = document.getElementById('codeInput').value.trim().toUpperCase();
    const resultEl = document.getElementById('result');

    if (!code.startsWith("GH-")) {
      resultEl.innerText = "❗️ Код має починатись з GH-";
      return;
    }

    // 1. Перевірка коду
    const res = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${code}&select=*`, {
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      }
    });

    const data = await res.json();

    if (!data.length) {
      resultEl.innerText = "❌ Код не знайдено.";
      return;
    }

    const promo = data[0];
    if (promo.used) {
      resultEl.innerText = "❌ Код вже використано.";
      return;
    }

    // 2. Шукаємо назву бонусу (тип) за user_id
    const bonusRes = await fetch(`${supabaseUrl}/rest/v1/bonuses?user_id=eq.${promo.user_id}&used=eq.true&order=created_at.desc&limit=1`, {
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      }
    });

    const bonusData = await bonusRes.json();
    let bonusTitle = "Обраний бонус";

    if (bonusData.length > 0) {
      const bonus = availableBonuses.find(b => b.name === bonusData[0].name);
      bonusTitle = bonus?.title || bonusTitle;
    }

    // 3. Списуємо
    const update = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${code}`, {
      method: "PATCH",
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ used: true })
    });

    if (update.ok) {
      resultEl.innerText = `✅ Знижку застосовано: ${bonusTitle}!`;
    } else {
      resultEl.innerText = "⚠️ Помилка при оновленні. Спробуйте ще раз.";
    }
  }
</script>

