<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Å–∏—Ä | –ó–Ω–∏–∂–∫–æ–≤–∏–π –∫–æ–¥</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px 20px;
      background-color: #fffefc;
      text-align: center;
    }
    h1 {
      color: #222;
    }
    input {
      padding: 12px;
      font-size: 18px;
      width: 80%;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
    }
    #pinSection {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
    

  <div id="pinSection">
    <h1>üîê –î–æ—Å—Ç—É–ø –∫–∞—Å–∏—Ä–∞</h1>
    <input type="password" id="pinInput" placeholder="–í–≤–µ–¥—ñ—Ç—å PIN" />
    <br>
    <button onclick="checkPin()">–£–≤—ñ–π—Ç–∏</button>
    <div class="result" id="pinResult"></div>
  </div>
  <div id="appSection"  style="display: none;">
  <h1>–°–ø–∏—Å–∞–Ω–Ω—è –∑–Ω–∏–∂–∫–∏</h1>
  <input type="text" id="codeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ (GH-...)" />
  <br>
  <button onclick="checkCode()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
  <div class="result" id="result"></div>
  </div>
 <script>
  const supabaseUrl = 'https://mftgqxilushpzewpqkvi.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // —Å–∫–æ—Ä–æ—á–µ–Ω–æ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ

  const CORRECT_PIN = '9548';

  const availableBonuses = [
    {
      name: "gyros",
      title: "-50% –Ω–∞ –≥—ñ—Ä–æ—Å",
    },
    {
      name: "potato",
      title: "–í–µ–ª–∏–∫–∞ –∫–∞—Ä—Ç–æ–ø–ª—è –∑–∞ 35 –≥—Ä–Ω",
    }
  ];

  function checkPin() {
    const pin = document.getElementById('pinInput').value.trim();
    const pinResult = document.getElementById('pinResult');

    if (pin === CORRECT_PIN) {
      document.getElementById('pinSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
    } else {
      pinResult.innerText = "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥.";
    }
  }

  async function checkCode() {
  const code = document.getElementById('codeInput').value.trim().toUpperCase();
  const resultEl = document.getElementById('result');

  if (!code.startsWith("GH-")) {
    resultEl.innerText = "‚ùóÔ∏è –ö–æ–¥ –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—å –∑ GH-";
    return;
  }

  // ‚úÖ FIX: encodeURIComponent
  const res = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${encodeURIComponent(code)}&select=*`, {
    headers: {
      apikey: supabaseKey,
      Authorization: `Bearer ${supabaseKey}`
    }
  });

  const data = await res.json();

  if (!data.length) {
    resultEl.innerText = "‚ùå –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
    return;
  }

  const promo = data[0];
  if (promo.used) {
    resultEl.innerText = "‚ùå –ö–æ–¥ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ.";
    return;
  }

    // 2. –®—É–∫–∞—î–º–æ –Ω–∞–∑–≤—É –±–æ–Ω—É—Å—É (—Ç–∏–ø) –∑–∞ user_id
    const bonusRes = await fetch(`${supabaseUrl}/rest/v1/bonuses?user_id=eq.${promo.user_id}&used=eq.true&order=created_at.desc&limit=1`, {
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`
      }
    });

    const bonusData = await bonusRes.json();
    let bonusTitle = "–û–±—Ä–∞–Ω–∏–π –±–æ–Ω—É—Å";

    if (bonusData.length > 0) {
      const bonus = availableBonuses.find(b => b.name === bonusData[0].name);
      bonusTitle = bonus?.title || bonusTitle;
    }

    // 3. –°–ø–∏—Å—É—î–º–æ
    const update = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${code}`, {
      method: "PATCH",
      headers: {
        apikey: supabaseKey,
        Authorization: `Bearer ${supabaseKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ used: true })
    });

    if (update.ok) {
      resultEl.innerText = `‚úÖ –ó–Ω–∏–∂–∫—É –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ: ${bonusTitle}!`;
    } else {
      resultEl.innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.";
    }
  }
</script>
</body>
</html> 

