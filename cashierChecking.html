<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Å–∏—Ä | –ó–Ω–∏–∂–∫–æ–≤–∏–π –∫–æ–¥</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px 20px;
      background-color: #fffefc;
      text-align: center;
    }
    h1 {
      color: #222;
    }
    input {
      padding: 12px;
      font-size: 18px;
      width: 80%;
      max-width: 300px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
    }
    #pinSection {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
    <h1>üîê –î–æ—Å—Ç—É–ø –∫–∞—Å–∏—Ä–∞</h1>

  <div id="pinSection" style="display: none;">
    <input type="password" id="pinInput" placeholder="–í–≤–µ–¥—ñ—Ç—å PIN" />
    <br>
    <button onclick="checkPin()">–£–≤—ñ–π—Ç–∏</button>
    <div class="result" id="pinResult"></div>
  </div>
  <h1>–°–ø–∏—Å–∞–Ω–Ω—è –∑–Ω–∏–∂–∫–∏</h1>
  <input type="text" id="codeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ (GH-...)" />
  <br>
  <button onclick="checkCode()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
  <div class="result" id="result"></div>

  <script>
    const supabaseUrl = 'https://mftgqxilushpzewpqkvi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mdGdxeGlsdXNocHpld3Bxa3ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMDQxMzMsImV4cCI6MjA2Njg4MDEzM30.qRsUDDHSFuP6hIQZwv0mVsfS-ZZDPPbDU5Zl55Hoezw';

 const CORRECT_PIN = '9548';

    function checkPin() {
      const pin = document.getElementById('pinInput').value.trim();
      const pinResult = document.getElementById('pinResult');

      if (pin === CORRECT_PIN) {
        document.getElementById('pinSection').style.display = 'none';
        document.getElementById('appSection').style.display = 'block';
      } else {
        pinResult.innerText = "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥.";
      }
    }

    
    async function checkCode() {
      const code = document.getElementById('codeInput').value.trim().toUpperCase();
      const resultEl = document.getElementById('result');

      if (!code.startsWith("GH-")) {
        resultEl.innerText = "‚ùóÔ∏è –ö–æ–¥ –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—å –∑ GH-";
        return;
      }

      // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î —Ç–∞–∫–∏–π –∫–æ–¥ —ñ —á–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π
      const res = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${code}&select=*`, {
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`
        }
      });

      const data = await res.json();

      if (!data.length) {
        resultEl.innerText = "‚ùå –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.";
        return;
      }

      if (data[0].used) {
        resultEl.innerText = "‚ùå –ö–æ–¥ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ.";
        return;
      }

      // 2. –ü–æ–∑–Ω–∞—á–∞—î–º–æ —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π
      const update = await fetch(`${supabaseUrl}/rest/v1/discount_codes?code=eq.${code}`, {
        method: "PATCH",
        headers: {
          apikey: supabaseKey,
          Authorization: `Bearer ${supabaseKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ used: true })
      });

      if (update.ok) {
        resultEl.innerText = "‚úÖ –ó–Ω–∏–∂–∫—É —É—Å–ø—ñ—à–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ!";
      } else {
        resultEl.innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.";
      }
    }
  </script>
</body>
</html>

