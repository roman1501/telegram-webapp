<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Greek House Tapper</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #004d00, #ffffff);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .tab-content {
      flex: 1;
      padding: 20px;
      display: none;
      overflow-y: auto;
    }
    .tab-content.active {
      display: block;
    }
    .tab-bar {
      display: flex;
      height: 60px;
      background: #004d00;
    }
    .tab-button {
      flex: 1;
      border: none;
      background: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-button.active {
      background: #66bb6a;
    }
    .tap-button {
      font-size: 20px;
      padding: 15px 30px;
      background-color: #43a047;
      color: white;
      border: none;
      border-radius: 12px;
      margin-top: 20px;
      cursor: pointer;
    }
    .tap-button:active {
      background-color: #2e7d32;
    }
    .counter {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    .bonus-item {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .inventory-item {
      background: #fffde7;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .logo {
      width: 100px;
      display: block;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <div id="tap-tab" class="tab-content active">
    <img src="logo.jfif" alt="logo" class="logo">
    <h2>–ü—Ä–∏–≤—ñ—Ç, <span id="username">...</span>!</h2>
    <button class="tap-button" id="tapBtn">–¢–ê–ü–ê–¢–ò üçó</button>
    <div class="counter">–ö–ª—ñ–∫—ñ–≤: <span id="clicksCount">...</span></div>
  </div>

  <div id="market-tab" class="tab-content">
    <h2>üè™ –†–∏–Ω–æ–∫</h2>
    <div class="counter">–í–∞—à—ñ –∫–ª—ñ–∫–∏: <span id="marketClicks">...</span></div>
    <div class="bonus-item">
      <h3>–ó–Ω–∏–∂–∫–∞ -50% –Ω–∞ –≥—ñ—Ä–æ—Å</h3>
      <p>–¶—ñ–Ω–∞: 1000 –∫–ª—ñ–∫—ñ–≤</p>
      <button class="tap-button" onclick="buyBonus('–ó–Ω–∏–∂–∫–∞ -50% –Ω–∞ –≥—ñ—Ä–æ—Å', 1000)">–ö—É–ø–∏—Ç–∏</button>
    </div>
    <div class="bonus-item">
      <h3>–í–µ–ª–∏–∫–∞ –∫–∞—Ä—Ç–æ–ø–ª—è –∑–∞ 35 –≥—Ä–Ω</h3>
      <p>–¶—ñ–Ω–∞: 700 –∫–ª—ñ–∫—ñ–≤</p>
      <button class="tap-button" onclick="buyBonus('–ö–∞—Ä—Ç–æ–ø–ª—è 35 –≥—Ä–Ω', 700)">–ö—É–ø–∏—Ç–∏</button>
    </div>
  </div>

  <div id="inventory-tab" class="tab-content">
    <h2>üéí –Ü–Ω–≤–µ–Ω—Ç–∞—Ä</h2>
    <div id="inventoryList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>

  <div class="tab-bar">
    <button class="tab-button active" onclick="showTab('tap-tab', this)">–¢–∞–ø–∞—Ç–∏</button>
    <button class="tab-button" onclick="showTab('market-tab', this)">–†–∏–Ω–æ–∫</button>
    <button class="tab-button" onclick="showTab('inventory-tab', this)">–Ü–Ω–≤–µ–Ω—Ç–∞—Ä</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const supabaseUrl = 'https://mftgqxilushpzewpqkvi.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_KEY';
    const headers = {
      apikey: supabaseKey,
      Authorization: `Bearer ${supabaseKey}`,
      'Content-Type': 'application/json'
    };

    const user = tg.initDataUnsafe?.user;
    if (!user) {
      alert('–¶–µ–π –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ —á–µ—Ä–µ–∑ Telegram');
      throw new Error('User not found');
    }

    const userId = user.id;
    document.getElementById('username').innerText = user.first_name || '–ì—ñ—Å—Ç—å';

    let clicks = 0;

    async function fetchClicks() {
      const res = await fetch(`${supabaseUrl}/rest/v1/clicks?user_id=eq.${userId}`, { headers });
      const data = await res.json();
      if (data.length) {
        clicks = data[0].clicks;
      } else {
        await fetch(`${supabaseUrl}/rest/v1/clicks`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ user_id: userId, clicks: 0, discounts: 0 })
        });
        clicks = 0;
      }
      updateCounters();
    }

    function updateCounters() {
      document.getElementById('clicksCount').innerText = clicks;
      document.getElementById('marketClicks').innerText = clicks;
    }

    async function saveClicks() {
      await fetch(`${supabaseUrl}/rest/v1/clicks?user_id=eq.${userId}`, {
        method: 'PATCH',
        headers,
        body: JSON.stringify({ clicks })
      });
    }

    document.getElementById('tapBtn').addEventListener('click', async () => {
      clicks++;
      updateCounters();
      await saveClicks();
    });

    async function buyBonus(name, price) {
      if (clicks < price) return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–ª—ñ–∫—ñ–≤');
      clicks -= price;
      updateCounters();
      await saveClicks();

      await fetch(`${supabaseUrl}/rest/v1/bonuses`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ user_id: userId, name, price, used: false })
      });

      alert(`üéÅ –ë–æ–Ω—É—Å "${name}" –∫—É–ø–ª–µ–Ω–æ!`);
      await renderInventory();
    }

    async function renderInventory() {
      const res = await fetch(`${supabaseUrl}/rest/v1/bonuses?user_id=eq.${userId}&used=eq.false`, { headers });
      const data = await res.json();
      const list = document.getElementById('inventoryList');
      list.innerHTML = '';
      if (!data.length) {
        list.innerText = '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –±–æ–Ω—É—Å—ñ–≤';
        return;
      }

      data.forEach(b => {
        const div = document.createElement('div');
        div.className = 'inventory-item';
        div.innerHTML = `
          <p>${b.name}</p>
          <button class="tap-button" onclick="activateBonus('${b.id}', '${b.name}')">–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏</button>
        `;
        list.appendChild(div);
      });
    }

    async function activateBonus(bonusId, name) {
      const code = generateCode();
      await fetch(`${supabaseUrl}/rest/v1/discount_codes`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ user_id: userId, code, used: false })
      });

      await fetch(`${supabaseUrl}/rest/v1/bonuses?id=eq.${bonusId}`, {
        method: 'PATCH',
        headers,
        body: JSON.stringify({ used: true })
      });

      alert(`–í–∞—à –∫–æ–¥: ${code}`);
      await renderInventory();
    }

    function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = 'GH-';
      for (let i = 0; i < 5; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function showTab(id, btn) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    fetchClicks();
    renderInventory();
  </script>
</body>
</html>

  
